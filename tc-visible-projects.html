<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<script src="./../lodash/lodash.min.js"></script>
<script src="./TcVisibleProjectsBehavior.js"></script>
<script src="./libs/ajax.js"></script>

<!--
`tc-visible-projects`
Teamcity component - Configure Visible Projects

### Styling

The following custom properties and mixins are available for styling:

Name | Type | Description | Default
----------------|-------------|----------
`--tc-text-color` | Prop | Text color | #000000
`--tc-primary-color` | Prop |  Application primary color | #0CB0F2
`--tc-secondary-color` | Prop |  Application secondary color | #39E865
`--tc-project-selector-item` | Mixin |  Applied to a project item | {}
`--tc-project-selector-item-hover` | Mixin |  Applied to a project item :hover | {}
`--tc-project-selector-item-nth-even` | Mixin |  Applied to a project item :nth-of-type(2n)  | {}

@demo demo/index.html
-->

<dom-module id="tc-visible-projects">
    <template>
        <style>
            :host {
                --tc-text-color: rgba(0,0,0,.87);
                --tc-primary-color: rgba(0,0,0,.87);
                --tc-secondary-color: rgba(0,0,0,.87);

                display: block;
                color: var(--tc-text-color);
            }

            #body {
                width: 100%;

                table-layout: fixed;
                border-collapse: collapse;
                border-spacing: 0;
            }

            #hiddenProjectsFilter {
                display: block;
                width: 100%;
                height: 1.3em;

                outline: none;
                background-color: transparent;

                margin: 0 0 1px 0;
                padding: 0 0 1px 0;
                font-size: inherit;

                border: none;
                border-bottom: 1px solid rgba(0,0,0,.12);
            }
            #hiddenProjectsFilter:focus {
                margin-bottom: 0;

                border-bottom-width: 2px;
                border-bottom-color: var(--tc-primary-color);
            }

            #searchIcon {
                position: absolute;
                top: 0;
                right: 0;
                z-index: 100;

                width: 20px;
                height: 20px;

                opacity: .3;
            }

            .text-secondary {
                color: var(--tc-text-color, rgba(0,0,0,.54));
            }

            .href-action {
                text-decoration: none;
                color: var(--tc-primary-color);
                border-bottom: 1px dotted var(--tc-primary-color);
            }

            .projects-container {
                width: 50%;
                border-left: 1px solid rgba(0,0,0,.12);

                padding-left: 16px;
                padding-right: 16px;

                vertical-align: top;
            }

            .projects-container:first-of-type {
                border-left: none;
                padding-left: 0;
            }

            .projects-container__title {
                position: relative;
                font-size: 1.1em;
                height: 32px;
            }

            .projects-container__selector {
                height: 325px;
                overflow: auto;
            }

            .project-item {
                cursor: default;
                @apply(--tc-project-selector-item);
            }
            .project-item:hover {
                @apply(--tc-project-selector-item-hover);
            }
            .project-item:nth-of-type(2n) {
                @apply(--tc-project-selector-item-nth-even);
            }
        </style>

        <table id="body">
            <tbody>
                <tr>
                    <td class="projects-container">
                        <div class="projects-container__title">
                            <strong>My visible projects</strong>
                        </div>
                        <div class="projects-container__selector">
                            <div id="visibleProjectsSelector">
                                <!-- ...visible projects will be here... -->
                            </div>
                        </div>
                    </td>

                    <td class="projects-container">
                        <div class="projects-container__title">
                            <!-- "keyup" event used here instead of "input" due to IE9 compatibility -->
                            <input id="hiddenProjectsFilter" type="text"
                                   placeholder="Find projects by name..."
                                   on-keyup="_onFilterKeyup">

                            <!-- Just meaningful icon -->
                            <iron-icon id="searchIcon" icon="icons:search"></iron-icon>
                        </div>

                        <div class="projects-container__selector">

                            <template is="dom-if" if="[[_ioIsLoading]]">
                                <div class="text-secondary">Loading projects...</div>
                            </template>

                            <template is="dom-if" if="[[_ioIsShowAllProjectsVisible]]">
                                <div class="text-secondary">
                                    <strong>[[_ioProjectsNodes.length]]</strong> projects found.
                                    <a class="href-action" href="#" on-tap="_onShowAllTap">
                                        Click or "<strong>â†“</strong>" to show all
                                    </a>
                                </div>
                            </template>

                            <div id="hiddenProjectsSelector">
                                <!-- ...hidden projects will be here... -->
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>

    <script>
        (function () {
            var Keycodes = {
                UP: 38,
                DOWN: 40,
                ENTER: 13,
                ESC: 27
            };

            Polymer({
                is: 'tc-visible-projects',
                behaviors: [ Polymer.jb.TcVisibleProjectsBehavior ],

                properties: {
                    /**
                     * Url to load json data
                     */
                    url: String,

                    /**
                     * Maximum number of projects to display without "Show all..."
                     */
                    projectsDisplayLimit: {
                        type: Number,
                        value: 100
                    }
                },

                /** @type {String} */
                _ioLastFilterValue: '',

                /** @type {Boolean} */
                _ioIsShowAllProjectsVisible: false,

                /** @type {Boolean} */
                _ioIsLoading: false,

                /** @type {Array<String>} */
                _ioProjectsNodes: null,

                ready: function () {
                    var projectTemplate = this.queryEffectiveChildren('template[name="group-template"]');
                    projectTemplate = projectTemplate ? projectTemplate.innerHTML.trim() : null;

                    this._init(projectTemplate);
                    this.loadProjects(this.url);
                },

                attached: function () {
                    // Wait ~10 ms until local DOM initialized
                    this.async(function () {
                        this.$.hiddenProjectsFilter.focus();
                    }, null, 10);
                },

                _ioSetLoading: function (isOn) {
                    this._ioIsLoading = isOn;
                },

                _ioGetFilter: function () {
                    return this.$.hiddenProjectsFilter.value.trim();
                },

                _ioShowProjectNodes: function (nodes, isForced) {
                    this._ioProjectsNodes = nodes;

                    if (!!isForced || this._ioProjectsNodes.length <= this.projectsDisplayLimit) {
                        this._ioIsShowAllProjectsVisible = false;
                        Polymer.dom(this.$.hiddenProjectsSelector).innerHTML = nodes.join('');
                    } else {
                        this._ioIsShowAllProjectsVisible = true;
                        Polymer.dom(this.$.hiddenProjectsSelector).innerHTML = '';
                    }
                },

                _ioShowError: function (message) {
//                    console.log(error.message);
                },

                _ioApplyFilter: _.debounce(function (filter) {
                    // Coz we use "keyup" event we should ensure that our filter is changed
                    if (filter === this._ioLastFilterValue) {
                        return;
                    }

                    this._ioLastFilterValue = filter;
                    this._projectNodes =
                        this._getFilteredProjects(this._projects, this._ioLastFilterValue, this._groupTemplate);
                    this._ioShowProjectNodes(this._projectNodes);
                }, 300),

                _ioSelectNextProject: function () {
                    if (this._ioIsShowAllProjectsVisible) {
                        this._ioShowProjectNodes(this._ioProjectsNodes, true);
                    }

                    //todo: impl
                },

                _ioSelectPrevProject: function () {
                    //todo: impl
                },

                _onFilterKeyup: function (e) {
                    e.stopPropagation();

                    switch (e.keyCode) {
                        case Keycodes.DOWN:
                            this._ioSelectNextProject();
                            break;
                        case Keycodes.UP:
                            this._ioSelectPrevProject();
                            break;
                        case Keycodes.ENTER:
                            break;
                        default:
                            this._ioApplyFilter(this._ioGetFilter());
                    }
                },

                _onShowAllTap: function (e) {
                    e.stopPropagation();
                    this._ioShowProjectNodes(this._ioProjectsNodes, true);
                }
            });
        })()
    </script>
</dom-module>
