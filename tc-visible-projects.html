<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="./tc-visible-projects-behavior.html">

<!--
## tc-visible-projects
Teamcity component - Configure Visible Projects

### Styling

The following custom properties and mixins are available for styling:

Name | Type | Description | Default
----------------|-------------|----------
`--tc-text-color` | Prop | Base text color | #000
`--tc-primary-color` | Prop |  Primary color | #666
`--tc-primary-text-color` | Prop |  Text color over primary color as background | #fff
`--tc-project-selector-height` | Prop | Height of project tree (final height will be +30px) | 370px
`--tc-project-selector-highlight-color` | Prop | Color of filtration highlight | #ffff80
`--tc-project-selector-item-nth-even` | Mixin |  Applied to a project item container :nth-of-type(2n)  | {}
`--tc-project-selector-item-template` | Mixin |  Applied to a project item  | {}
`--tc-project-selector-item-template-focused` | Mixin |  Applied to a project item :hover and :focus  | {}

@demo demo/index.html
-->

<dom-module id="tc-visible-projects">
    <template>
        <style>
            :host {
                --tc-text-color: rgba(0,0,0,.87);
                --tc-primary-color: #666;
                --tc-primary-text-color: #fff;

                --tc-project-selector-height: 370px;
                --tc-project-selector-highlight-color: #ffff80;

                display: block;
                outline: 0;
                color: var(--tc-text-color);
            }

            #body {
                width: 100%;

                table-layout: fixed;
                border-collapse: collapse;
                border-spacing: 0;
            }

            #hiddenProjectsFilter {
                display: block;
                width: 100%;
                height: 1.3em;

                outline: none;
                background-color: transparent;

                margin: 0 0 1px 0;
                padding: 0 0 1px 0;
                font-size: inherit;

                border: none;
                border-bottom: 1px solid rgba(0,0,0,.12);
            }
            #hiddenProjectsFilter:focus {
                margin-bottom: 0;

                border-bottom-width: 2px;
                border-bottom-color: var(--tc-primary-color);
            }

            #searchIcon {
                position: absolute;
                top: 0;
                right: 0;
                z-index: 100;

                width: 20px;
                height: 20px;

                opacity: .3;
            }

            #loader {
                text-align: center;
                padding-top: 12px;
                font-size: .9em;
            }
            #loader img {
                vertical-align: middle;
            }

            .text-secondary {
                color: var(--tc-text-color, rgba(0,0,0,.54));
            }

            .href-action {
                text-decoration: none;
                color: var(--tc-primary-color);
                border-bottom: 1px dotted var(--tc-primary-color);
            }

            .highlight {
                background-color: var(--tc-project-selector-highlight-color);
            }

            .hidden {
                display: none;
            }

            .projects-container {
                width: 50%;
                border-left: 1px solid rgba(0,0,0,.12);
                vertical-align: top;
            }

            .projects-container:first-of-type {
                border-left: none;
                padding-left: 0;
            }

            .projects-container__title {
                position: relative;
                font-size: 1.1em;
                height: 25px;
                padding: 0 16px;
            }

            .projects-container__body {
                height: var(--tc-project-selector-height);
                overflow: auto;
                padding: 5px 16px 0;
            }

            .projects-container__selector {
                outline: 0;
                margin: 0;
                padding: 0;
            }

            .projects-container__selector li {
                list-style-type: none;
            }

            .project-item {
                cursor: default;
            }
            .project-item:nth-of-type(2n) {
                @apply(--tc-project-selector-item-nth-even);
            }
            .project-item:hover,
            .project-item:focus {
                position: relative;
                cursor: pointer;
                outline: 0;

                border-collapse: separate;
                box-shadow: 0px 2px 2px 0px rgba(0, 0, 0, 0.14),
                            0px 1px 5px 0px rgba(0, 0, 0, 0.12),
                            0px 3px 1px -2px rgba(0, 0, 0, 0.2);

                margin: -3px -10px -3px -10px;
                padding: 3px 10px 3px 10px;

                color: var(--tc-primary-text-color);
                background-color: var(--tc-primary-color);
            }

            .project-item__template {
                @apply(--tc-project-selector-item-template);
            }

            .project-item__order {
                display: none;
                background-color: var(--tc-primary-color);
                padding-left: 3px;
                font-size: .8em;

                position: absolute;
                top: 8px;
                right: 3px;
            }

            .project-item__order-arrow {
                cursor: pointer;
                padding: 5px;
                opacity: .5;
            }
            .project-item__order-arrow[event-role="index-up"] { padding-right: 2px }
            .project-item__order-arrow[event-role="index-down"] { padding-left: 2px }
            .project-item__order-arrow:hover { opacity: 1; }

            #visibleProjectsSelector:hover .project-item:hover .project-item__order {
                display: inline-block;
            }

            .project-item:focus .project-item__template,
            .project-item:hover .project-item__template {
                @apply(--tc-project-selector-item-template-focused);
            }

            .project-item:focus .highlight,
            .project-item:hover .highlight {
                background-color: inherit;
            }

            /* Hope 9 levels will be enough */
            .project-level-1 { padding-left: 0px; }
            .project-level-2 { padding-left: 20px; }
            .project-level-3 { padding-left: 40px; }
            .project-level-4 { padding-left: 60px; }
            .project-level-5 { padding-left: 80px; }
            .project-level-6 { padding-left: 100px; }
            .project-level-7 { padding-left: 120px; }
            .project-level-8 { padding-left: 140px; }
            .project-level-9 { padding-left: 160px; }
        </style>

        <!--[if IE]>
        <style>
            #ieFilterPlaceholder {
                color: gray;
                pointer-events: none;
                cursor: default;

                position: absolute;
                top: 0;
                left: 20px;
            }
            #ieFilterPlaceholder.hidden {
                display: none;
            }

        </style>
        <![endif]-->

        <iron-localstorage id="selectedProjectsStore" name="tc-visible-projects:selected-projects"></iron-localstorage>

        <table id="body">
            <tbody>
                <tr>
                    <td class="projects-container">
                        <div class="projects-container__title">
                            <strong>My visible projects</strong>
                        </div>
                        <div class="projects-container__body">
                            <ul id="visibleProjectsSelector" class="projects-container__selector"
                                on-tap="_onVisibleProjectTapDelegator">
                                <!-- ...visible projects will be here... -->
                            </ul>
                        </div>
                    </td>

                    <td class="projects-container">
                        <div class="projects-container__title">
                            <input id="hiddenProjectsFilter"
                                   type="text" placeholder="Find projects by name..."
                                   on-focus="_onFilterFocus"
                                   on-keydown="_onFilterKeydown">

                            <!-- Very special placeholder for IE -->
                            <!--[if IE]>
                            <span id="ieFilterPlaceholder"
                                  on-click="_ieOnPlaceholderTap"
                                  on-selectstart="_ieOnPlaceholderSelectionStart">
                                Find projects by name...
                            </span>
                            <![endif]-->

                            <!-- Just meaningful icon -->
                            <iron-icon id="searchIcon" icon="icons:search"></iron-icon>
                        </div>

                        <div id="hiddenProjectsBody" class="projects-container__body">

                            <template is="dom-if" if="[[_isLoading]]">
                                <div id="loader" class="text-secondary">
                                    <img src="img/ajax-loader.gif"> Loading projects...
                                </div>
                            </template>

                            <ul id="hiddenProjectsSelector" class="projects-container__selector hidden"
                                on-tap="_onHiddenProjectTapDelegator">
                                <!-- ...hidden projects will be here... -->
                            </ul>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>

    <script>
        (function () {
            var Keycodes = {
                UP: 38,
                LEFT: 37,
                DOWN: 40,
                ENTER: 13,
                ESC: 27
            };

            var Classes = {
                PROJECT: 'project-item',
                PROJECT_TEMPLATE: 'project-item__template',
                PROJECT_ORDER: 'project-item__order',
                PROJECT_ORDER_ARROW: 'project-item__order-arrow',
                PROJECT_LEVEL_PREFIX: 'project-level-',
                HIGHLIGHT: 'highlight',
                HIDDEN: 'hidden'
            };

            var log = emptyFn;

            function emptyFn() {}

            function getDelegationInfo(target, delegator) {
                var role;

                while (target !== delegator) {
                    if (target.hasAttribute('event-role')) {
                        role = target.getAttribute('event-role');
                        break;
                    }
                    target = Polymer.dom(target).parentNode;
                }

                if (role) {
                    return { target: target, role: role };
                }

                return null;
            }

            Polymer({
                /**
                 * Save current selected projects into LocalStorage
                 */
                commit: function () {
                    this.$.selectedProjectsStore.value = this._getSelectedProjects();
                    this.$.selectedProjectsStore.save();
                },

                /**
                 * Reload selected projects from LocalStorage
                 */
                reset: function () {
                    this._initSelectedProjects();
                },

                is: 'tc-visible-projects',
                behaviors: [ Polymer.jb.TcVisibleProjectsBehavior ],

                properties: {
                    /**
                     * Url to load json data
                     */
                    url: String,

                    /**
                     * Filtration input debounce delay
                     */
                    delay: {
                        type: Number,
                        value: 100
                    },

                    /**
                     * Disable filtration highlighting useful for slow browsers (Hello IE)
                     */
                    noHighlight: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Highlight count per iteration.
                     * Typically ~max simultaneously visible rows inside selector
                     */
                    highlightFactor: {
                        type: Number,
                        value: 30
                    },

                    /**
                     * True - to enable logs
                     */
                    debug: {
                        type: Boolean,
                        value: false,
                        observer: '_debugChanged'
                    }
                },

                hostAttributes: {
                    tabindex: 0
                },

                listeners: {
                    'keydown': '_onHostKeydown',
                },

                /** @type {Number} */
                _readyTs: NaN,

                /** @type {String} */
                _lastFilterValue: null,

                /** @type {Boolean} */
                _isLoading: false,

                /** @type {Array<Node>} */
                _projectsNodes: null,

                /**
                 * Template for hidden projects
                 * @type {Function}
                 */
                _hiddenProjectTemplateFn: null,

                /**
                 * Template for visible projects
                 * @type {Function}
                 */
                _visibleProjectTemplateFn: null,

                /** @type {Object} */
                _highlightJob: null,

                /** @type {Node} */
                _focusedNode: null,

                ready: function () {
                    this._readyTs = (new Date()).getTime();
                    this._projectsNodes = [];
                    this._initProjectTemplate();
                    this._initSelectedProjects();
                    this._loadProjects(this.url);
                },

                attached: function () {
                    // Ensure local DOM initialized
                    this.async(function () {
                        this.$.hiddenProjectsFilter.focus();
                    }, 1);
                },

                detached: function () {
                    this._destructor();
                    this._projectsNodes = null;
                },

                _ioSetLoading: function (isOn) {
                    this._isLoading = isOn;
                },

                _ioGetFilter: function () {
                    return this.$.hiddenProjectsFilter.value.trim();
                },

                /**
                 * Fired when error is thrown.
                 *
                 *     'event.detail.message' {String} error message
                 *     'event.detail.code' {String} error code
                 *
                 * @event error
                 */

                /**
                 * Dispatch 'error' event
                 * @param message {String}
                 * @param code {String}
                 */
                _ioFireError: function (message, code) {
                    this.fire('error', { message: message, code: code });
                    log(code + ': \'' + message + '\'');
                },


                /**
                 * Compile hidden project HTML using template
                 * @param project {{id: String, name: String, parentProjectId: String, description: String, href: String, webUrl: String, }}
                 * @param level {Number}
                 * @return {String} valid raw HTML
                 */
                _ioGetHiddenProjectHTML: function (project, level) {
                    return this._hiddenProjectTemplateFn(_.create(project, { _level: level }));
                },


                /**
                 * Compile visible project HTML using template
                 * @param project {{id: String, name: String, parentProjectId: String, description: String, href: String, webUrl: String, }}
                 * @param level {Number}
                 * @return {String} valid raw HTML
                 */
                _ioGetVisibleProjectHTML: function (project, name, level) {
                    return this._visibleProjectTemplateFn(_.create(project, { name: name, _level: level }));
                },

                /**
                 * Render hidden projects list inside selector
                 * @param html {Array<String>} list of HTML strings
                 */
                _ioRenderHiddenProjects: function (html) {
                    Polymer.dom(this.$.hiddenProjectsSelector).innerHTML = html.join('');
                    this._projectsNodes = this.$.hiddenProjectsSelector.childNodes;

                    this.async(function () {
                        log('Initial render time: ', (new Date()).getTime() - this._readyTs);
                    }, 1);
                },

                _ioRenderVisibleProjects: function (html) {
                    Polymer.dom(this.$.visibleProjectsSelector).innerHTML = html.join('');
                },

                _ioHideProjectNode: function (node) {
                    node.style.display = 'none';
                },

                _ioShowProjectNode: function (node) {
                    node.style.display = '';
                },

                /**
                 * Applies current filter if it was changed
                 * @param [forced] {Boolean} true - to skip filter dirty checking
                 */
                _ioApplyCurrentFilter: function (forced) {
                    // Prevent highlight progress
                    this.cancelAsync(this._highlightJob);

                    var filter = this._ioGetFilter();
                    var isFilterChanged = filter !== this._lastFilterValue;

                    // Coz we use "keyup" event we should ensure that our filter is changed
                    if (!forced && !isFilterChanged) {
                        return;
                    }

                    var isProgressive = forced ? false : filter.indexOf(this._lastFilterValue) === 0;
                    this._lastFilterValue = filter;

                    var ts = (new Date()).getTime();
                    this._filterProjectsNodes(filter, isProgressive);
                    log('Filtration time: ', (new Date()).getTime() - ts);

                    // Reset scroll if filter was changed
                    if (isFilterChanged) {
                        this.$.hiddenProjectsBody.scrollTop = 0;
                    }

                    // Reveal selector on first apply
                    this.$.hiddenProjectsSelector.classList.remove(Classes.HIDDEN);
                },

                _debugChanged: function (isOn) {
                    if (isOn)  {
                        log = console.log || emptyFn;
                    } else {
                        log = emptyFn;
                    }
                },

                /**
                 * Extract and prepare template from Light DOM
                 * <template name="group-template"> ... </template>
                 */
                _initProjectTemplate: function () {
                    var projectTemplate = this.queryEffectiveChildren('template[name="group-template"]');

                    if (projectTemplate) {
                        projectTemplate = projectTemplate.innerHTML.trim();
                    } else {
                        projectTemplate = '<div class="project-item__template" is-name>${name}</div>';
                    }

                    var hiddenProjectTemplate = [
                        '<li class="' + Classes.PROJECT + '" data-id="${id}" data-name="${name}" data-level="${_level}" ' +
                            'event-role="select" tabindex="-1">',
                            '<div class="' + Classes.PROJECT_LEVEL_PREFIX + '${_level}">',
                                projectTemplate,
                                /* order controls will be */
                            '</div>',
                        '</li>'
                    ];
                    var visibleProjectTemplate = hiddenProjectTemplate.slice();
                    visibleProjectTemplate.splice(
                        hiddenProjectTemplate.indexOf(projectTemplate) + 1, 0,
                        '<div class="' + Classes.PROJECT_ORDER + '">',
                            '<span class="' + Classes.PROJECT_ORDER_ARROW + '" event-role="index-up" data-id="${id}" title="Move project up">▲</span>',
                            '<span class="' + Classes.PROJECT_ORDER_ARROW + '" event-role="index-down" data-id="${id}" title="Move project down">▼</span>',
                        '</div>'
                    )

                    this._hiddenProjectTemplateFn = _.template(hiddenProjectTemplate.join(''));
                    this._visibleProjectTemplateFn = _.template(visibleProjectTemplate.join(''));
                },

                _initSelectedProjects: function () {
                    this.$.selectedProjectsStore.reload();
                    this._setSelectedProjects(this.$.selectedProjectsStore.value);
                },

                /**
                 * Show/hide hidden projects nodes based on filter
                 * @param filter {String}
                 * @param [isProgressive] {Boolean}
                 */
                _filterProjectsNodes: function (filter, isProgressive) {
                    var filtered = this._getFilteredProjects(filter, isProgressive);
                    var highlight = [];
                    var filterParts = filter.split(' ');
                    var _node, _id;

                    for (var i = 0, len = this._projectsNodes.length; i < len; i++) {
                        _node = this._projectsNodes[i];
                        _id = _node.getAttribute('data-id');

                        if (filtered[_id]) {
                            this._ioShowProjectNode(_node);
                            highlight.push(_node);
                        } else {
                            this._ioHideProjectNode(_node);
                        }
                    }

                    // Highlighting is heavy, so do it async to prevent UI blocks
                    if (! this.noHighlight) {
                        this._highlightJob = this.async(function () {
                            this._highlightProjects(highlight, filterParts);
                        }, 1);
                    }
                },

                /**
                 * Iteratively highlight all nodes (non blocking UI)
                 * @param nodes {Array<Element>}
                 * @param [highlight] {Array<String>} strings to highlight
                 */
                _highlightProjects: function (nodes, highlight, step) {
                    step = step || 0;

                    var stepSize = this.highlightFactor;
                    var index = step * stepSize;
                    var length = index + stepSize > nodes.length
                        ? nodes.length
                        : index + stepSize;

                    while (index < length) {
                        this._highlightProject(nodes[index], highlight);
                        index++;
                    }

                    // Next iteration
                    if (!(index >= nodes.length - 1)) {
                        this._highlightJob = this.async(function () {
                            this._highlightProjects(nodes, highlight, step + 1);
                        }, 1);
                    }
                },

                /**
                 * Highlight node name
                 * @param node {Element}
                 * @param [highlight] {Array<String>} strings to highlight
                 */
                _highlightProject: function (node, highlight) {
                    var name = node.getAttribute('data-name');
                    var nameParts = [];

                    if (highlight) {
                        var _nameTail = name;
                        var _highlight, _exec, _matched;

                        for (var i = 0, len = highlight.length; i < len; i++) {
                            _highlight = highlight[i];
                            _exec = new RegExp('(' + _.escapeRegExp(_highlight) + ')', 'i').exec(_nameTail);

                            if (_exec) {
                                _matched = _exec[1/* take only first match */];
                                nameParts.push(_nameTail.substr(0, _exec.index)
                                    + '<span class="' + Classes.HIGHLIGHT + '">' + _matched + '</span>');
                                _nameTail = _nameTail.substr(_exec.index + _matched.length);
                            }
                        }

                        nameParts.push(_nameTail);
                    } else {
                        nameParts.push(name)
                    }

                    Polymer.dom(Polymer.dom(node).querySelector('[is-name]')).innerHTML = nameParts.join('');
                },

                _setProjectSelected: function (id, isSelected) {
                    if (isSelected) {
                        this._selectProject(id);
                    } else {
                        this._unselectProject(id);
                    }
                },

                /**
                 * @param node {Node}
                 * @return {Node} next visible node
                 */
                _getNextVisibleProject: function (node) {
                    if (! node) {
                        return null;
                    }
                    node = Polymer.dom(node).nextSibling;

                    while (node) {
                        if (node.style.display !== 'none') {
                            break;
                        }
                        node = Polymer.dom(node).nextSibling;
                    }

                    if (! node) {
                        if (this._projectsNodes.length < 1) {
                            return null;
                        }
                        node = Polymer.dom(this.$.hiddenProjectsSelector).firstChild;
                    }

                    return node;
                },

                /**
                 * @param node {Node}
                 * @return {Node} previous visible node
                 */
                _getPrevVisibleProject: function (node) {
                    if (! node) {
                        return null;
                    }
                    node = Polymer.dom(node).previousSibling;

                    while (node) {
                        if (node.style.display !== 'none') {
                            break;
                        }
                        node = Polymer.dom(node).previousSibling;
                    }

                    if (! node) {
                        if (this._projectsNodes.length < 1) {
                            return null;
                        }
                        node = Polymer.dom(this.$.hiddenProjectsSelector).lastChild;
                    }

                    return node;
                },

                _onHostKeydown: function (e) {
                    e.stopPropagation();

                    switch (e.keyCode) {
                        case Keycodes.DOWN:
                            e.preventDefault();
                            this._focusedNode = this._getNextVisibleProject(
                                this._focusedNode || Polymer.dom(this.$.hiddenProjectsSelector).firstChild
                            )
                            if (this._focusedNode) {
                                this._focusedNode.focus();
                            }
                            break;
                        case Keycodes.UP:
                            e.preventDefault();
                            this._focusedNode = this._getPrevVisibleProject(
                                this._focusedNode || Polymer.dom(this.$.hiddenProjectsSelector).lastChild
                            );
                            if (this._focusedNode) {
                                this._focusedNode.focus();
                            }
                            break;
                        case Keycodes.LEFT:
                            e.preventDefault();
                            this._setProjectSelected(e.target.getAttribute('data-id'), true);
                            this.async(function () {
                                this._focusedNode = this._getNextVisibleProject(
                                    this._focusedNode || Polymer.dom(this.$.hiddenProjectsSelector).firstChild
                                );
                                if (this._focusedNode) {
                                    this._focusedNode.focus();
                                }
                            }, 10);
                            break;
                        case Keycodes.ESC:
                            e.preventDefault();
                            this.$.hiddenProjectsFilter.focus();
                            break;
                    }
                },

                _onFilterKeydown: function (e) {
                    e.stopPropagation();

                    switch (e.keyCode) {
                        case Keycodes.DOWN:
                            e.preventDefault();
                            this._focusedNode = this._getNextVisibleProject(Polymer.dom(this.$.hiddenProjectsSelector).firstChild);
                            if (this._focusedNode) {
                                this._focusedNode.focus();
                            }
                            break;
                        case Keycodes.UP:
                            e.preventDefault();
                            this._focusedNode = this._getPrevVisibleProject(Polymer.dom(this.$.hiddenProjectsSelector).lastChild);
                            if (this._focusedNode) {
                                this._focusedNode.focus();
                            }
                            break;
                        default:
                            this.debounce('applyFilterOnInput', function () {
                                this._ioApplyCurrentFilter();
                            }, this.delay);
                    }

                    /* IE Placeholder show/hide */
                    if (this.$.ieFilterPlaceholder) {
                        if (!!e.target.value) {
                            this.$.ieFilterPlaceholder.classList.add(Classes.HIDDEN);
                        } else {
                            this.$.ieFilterPlaceholder.classList.remove(Classes.HIDDEN);
                        }
                    }
                },

                _onFilterFocus: function (e) {
                    e.target.select();
                },

                _onHiddenProjectTapDelegator: function (e) {
                    e.stopPropagation();
                    var info = getDelegationInfo(e.target, this.$.hiddenProjectsSelector);

                    if (info && info.role === 'select') {
                        this._setProjectSelected(info.target.getAttribute('data-id'), true);
                        this.async(function () {
                            this._focusedNode = this._getNextVisibleProject(info.target);
                            this.focus();
                        }, 100);
                    }
                },

                _onVisibleProjectTapDelegator: function (e) {
                    e.stopPropagation();
                    var info = getDelegationInfo(e.target, this.$.visibleProjectsSelector);

                    if (info) {
                        if (info.role === 'select') {
                            this._setProjectSelected(info.target.getAttribute('data-id'), false);
                        } else if (info.role === 'index-up') {
                            this.shiftProject(info.target.getAttribute('data-id'), true);
                        } else if (info.role === 'index-down') {
                            this.shiftProject(info.target.getAttribute('data-id'));
                        }
                    }
                },

                /**
                 * Refocus input below
                 */
                _ieOnPlaceholderTap: function (e) {
                    e.stopPropagation();
                    this.$.hiddenProjectsFilter.focus();
                },

                /**
                 * Prevent placeholder text selection
                 */
                _ieOnPlaceholderSelectionStart: function (e) {
                    e.preventDefault();
                    return false;
                }
            });
        })()
    </script>
</dom-module>
