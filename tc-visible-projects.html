<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="./tc-visible-projects-behavior.html">

<!--
## tc-visible-projects
Teamcity component - Configure Visible Projects

### Styling

The following custom properties and mixins are available for styling:

Name | Type | Description | Default
----------------|-------------|----------
`--tc-text-color` | Prop | Text color | #000000
`--tc-primary-color` | Prop |  Application primary color | #0CB0F2
`--tc-secondary-color` | Prop |  Application secondary color | #39E865
`--tc-project-selector-highlight-color` | Prop | Color of filtration highlight | #ffff80
`--tc-project-selector-height` | Prop | Height of project tree (final height will be +30px) | 370px
`--tc-project-selector-item` | Mixin |  Applied to a project item | {}
`--tc-project-selector-item-hover` | Mixin |  Applied to a project item :hover | {}
`--tc-project-selector-item-nth-even` | Mixin |  Applied to a project item :nth-of-type(2n)  | {}

@demo demo/index.html
-->

<dom-module id="tc-visible-projects">
    <template>
        <style>
            :host {
                --tc-text-color: rgba(0,0,0,.87);
                --tc-primary-color: rgba(0,0,0,.87);
                --tc-secondary-color: rgba(0,0,0,.87);
                --tc-project-selector-height: 370px;
                --tc-project-selector-highlight-color: #ffff80;

                display: block;
                color: var(--tc-text-color);
            }

            #body {
                width: 100%;

                table-layout: fixed;
                border-collapse: collapse;
                border-spacing: 0;
            }

            #hiddenProjectsFilter {
                display: block;
                width: 100%;
                height: 1.3em;

                outline: none;
                background-color: transparent;

                margin: 0 0 1px 0;
                padding: 0 0 1px 0;
                font-size: inherit;

                border: none;
                border-bottom: 1px solid rgba(0,0,0,.12);
            }
            #hiddenProjectsFilter:focus {
                margin-bottom: 0;

                border-bottom-width: 2px;
                border-bottom-color: var(--tc-primary-color);
            }

            #searchIcon {
                position: absolute;
                top: 0;
                right: 0;
                z-index: 100;

                width: 20px;
                height: 20px;

                opacity: .3;
            }

            #loader {
                text-align: center;
                padding-top: 12px;
                font-size: .9em;
            }
            #loader img {
                vertical-align: middle;
            }

            .text-secondary {
                color: var(--tc-text-color, rgba(0,0,0,.54));
            }

            .href-action {
                text-decoration: none;
                color: var(--tc-primary-color);
                border-bottom: 1px dotted var(--tc-primary-color);
            }

            .highlight {
                background-color: var(--tc-project-selector-highlight-color);
            }

            .projects-container {
                width: 50%;
                border-left: 1px solid rgba(0,0,0,.12);
                vertical-align: top;
            }

            .projects-container:first-of-type {
                border-left: none;
                padding-left: 0;
            }

            .projects-container__title {
                position: relative;
                font-size: 1.1em;
                height: 25px;
                padding: 0 16px;
            }

            .projects-container__body {
                height: var(--tc-project-selector-height);
                overflow: auto;
                padding: 5px 16px 0;
            }

            .projects-container__selector {
                margin: 0;
                padding: 0;
            }

            .project-item {
                cursor: default;
                list-style-type: none;
            }
            .project-item:nth-of-type(2n) {
                @apply(--tc-project-selector-item-nth-even);
            }
            .project-item:hover,
            .project-item:focus,
            .project-item.focused {
                position: relative;
                cursor: pointer;
                outline: 0;

                border-collapse: separate;
                box-shadow: 0px 2px 2px 0px rgba(0, 0, 0, 0.14),
                            0px 1px 5px 0px rgba(0, 0, 0, 0.12),
                            0px 3px 1px -2px rgba(0, 0, 0, 0.2);

                margin: -3px -10px -3px -10px;
                padding: 3px 10px 3px 10px;

                background-color: var(--tc-primary-color);
            }

            .project-item__template {
                @apply(--tc-project-selector-item-template);
            }

            .project-item:hover .project-item__template {
                @apply(--tc-project-selector-item-template-focused);
            }

            /*.project-item:hover:after {*/
                /*position: absolute;*/
                /*top: 0;*/
                /*left: -7px;*/
                /*content: '';*/

                /*width: 0;*/
                /*height: 0;*/
                /*border-top: 13.5px solid transparent;*/
                /*border-bottom: 13.5px solid transparent;*/

                /*border-right: 8px solid var(--tc-primary-color);*/
            /*}*/

            /* Hope 9 levels will be enough */
            .project-level-1 { padding-left: 0px; }
            .project-level-2 { padding-left: 20px; }
            .project-level-3 { padding-left: 40px; }
            .project-level-4 { padding-left: 60px; }
            .project-level-5 { padding-left: 80px; }
            .project-level-6 { padding-left: 100px; }
            .project-level-7 { padding-left: 120px; }
            .project-level-8 { padding-left: 140px; }
            .project-level-9 { padding-left: 160px; }
        </style>

        <!--[if IE]>
        <style>
            #ieFilterPlaceholder {
                color: gray;
                pointer-events: none;
                cursor: default;

                position: absolute;
                top: 0;
                left: 20px;
            }
            #ieFilterPlaceholder.hidden {
                display: none;
            }

        </style>
        <![endif]-->

        <table id="body">
            <tbody>
                <tr>
                    <td class="projects-container">
                        <div class="projects-container__title">
                            <strong>My visible projects</strong>
                        </div>
                        <div class="projects-container__body">
                            <ul id="visibleProjectsSelector"
                                class="projects-container__selector"
                                on-tap="_onVisibleProjectTapDelegator">
                                <!-- ...visible projects will be here... -->
                            </ul>
                        </div>
                    </td>

                    <td class="projects-container">
                        <div class="projects-container__title">
                            <input id="hiddenProjectsFilter"
                                   type="text" placeholder="Find projects by name..."
                                   on-focus="_onFilterFocus"
                                   on-keyup="_onFilterKeyup">

                            <!-- Very special placeholder for IE -->
                            <!--[if IE]>
                            <span id="ieFilterPlaceholder"
                                  on-click="_ieOnPlaceholderTap"
                                  on-selectstart="_ieOnPlaceholderSelectionStart">
                                Find projects by name...
                            </span>
                            <![endif]-->

                            <!-- Just meaningful icon -->
                            <iron-icon id="searchIcon" icon="icons:search"></iron-icon>
                        </div>

                        <div id="hiddenProjectsBody" class="projects-container__body">

                            <template is="dom-if" if="[[_isLoading]]">
                                <div id="loader" class="text-secondary">
                                    <img src="img/ajax-loader.gif"> Loading projects...
                                </div>
                            </template>

                            <template is="dom-if" if="[[_isShowAllProjectsVisible]]">
                                <div class="text-secondary">
                                    <strong>[[_projectsNodes.length]]</strong> projects found.
                                    <a class="href-action" href="#" on-tap="_onShowAllTap">
                                        Click or "<strong>â†“</strong>" to show all
                                    </a>
                                </div>
                            </template>

                            <ul id="hiddenProjectsSelector" class="projects-container__selector"
                                on-tap="_onHiddenProjectTapDelegator">
                                <!-- ...hidden projects will be here... -->
                            </ul>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>

    <script>
        (function () {
            var Keycodes = {
                UP: 38,
                DOWN: 40,
                ENTER: 13,
                ESC: 27
            };

            var Classes = {
                PROJECT: 'project-item',
                PROJECT_TEMPLATE: 'project-item__template',
                PROJECT_LEVEL_PREFIX: 'project-level-',
                HIGHLIGHT: 'highlight',
                FOCUSED: 'focused',
                HIDDEN: 'hidden'
            };

            var log = emptyFn;

            function emptyFn() {}

            function getDelegateTarget(source, delegator, cls) {
                var target = null;

                while (source !== delegator && !source.classList.contains(cls)) {
                    source = Polymer.dom(source).parentNode;
                }

                if (source.classList.contains(Classes.PROJECT)) {
                    target =  source;
                }

                return target;
            }

            function ioApplyCurrentFilter () {
                // Prevent highlight progress
                this.cancelAsync(this._highlightJob);

                var filter = this._ioGetFilter();

                // Coz we use "keyup" event we should ensure that our filter is changed
                if (filter === this._lastFilterValue) {
                    return;
                }

                var isProgressive = filter.indexOf(this._lastFilterValue) === 0;
                this._lastFilterValue = filter;

                var ts = (new Date()).getTime();
                this._filterProjectsNodes(filter, isProgressive);
                log('Filtration time: ', (new Date()).getTime() - ts);

                // Reset scroll
                this.$.hiddenProjectsBody.scrollTop = 0;
            };

            Polymer({
                is: 'tc-visible-projects',
                behaviors: [ Polymer.jb.TcVisibleProjectsBehavior ],

                properties: {
                    /**
                     * Url to load json data
                     */
                    url: String,

                    /**
                     * Maximum number of projects to display without "Show all..."
                     */
                    projectsDisplayLimit: {
                        type: Number,
                        value: 100
                    },

                    /**
                     * Filtration input debounce delay
                     */
                    delay: {
                        type: Number,
                        value: 100,
                        observer: '_delayChanged'
                    },

                    /**
                     * Disable filtration highlighting useful for slow browsers (Hello IE)
                     */
                    noHighlight: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Highlight count per iteration.
                     * Typically ~max projects rows inside selector
                     */
                    highlightFactor: {
                        type: Number,
                        value: 20
                    },

                    /**
                     * Set to true to enable logs
                     */
                    debug: {
                        type: Boolean,
                        value: false,
                        observer: '_debugChanged'
                    }
                },

                /** @type {Number} */
                _readyTs: NaN,

                /** @type {String} */
                _lastFilterValue: '',

                /** @type {Boolean} */
                _isShowAllProjectsVisible: false,

                /** @type {Boolean} */
                _isLoading: false,

                /** @type {Array<Node>} */
                _projectsNodes: null,

                /** @type {Function} */
                _projectTemplateFn: null,

                /** @type {Object} */
                _highlightJob: null,

                ready: function () {
                    this._readyTs = (new Date()).getTime();
                    this._projectsNodes = [];
                    this._initProjectTemplate();
                    this.loadProjects(this.url);
                },

                attached: function () {
                    // Ensure local DOM initialized
                    this.async(function () {
                        this.$.hiddenProjectsFilter.focus();
                    }, 1);
                },

                _ioSetLoading: function (isOn) {
                    this._isLoading = isOn;
                },

                _ioGetFilter: function () {
                    return this.$.hiddenProjectsFilter.value.trim();
                },

                /**
                 * Fired when error is thrown.
                 *
                 *     'event.detail.message' {String} error message
                 *     'event.detail.code' {String} error code
                 *
                 * @event error
                 */

                /**
                 * Dispatch 'error' event
                 * @param message {String}
                 * @param code {String}
                 */
                _ioShowError: function (message, code) {
                    this.fire('error', { message: message, code: code });
                },

                _ioGetProjectHTML: function (project) {
                    /**
                    * Creates new object because we don`t know which properties from original project object
                     * will be used in project item custom template, so we need them all.
                     */
                    return this._projectTemplateFn(project);
                },

                _ioRenderHiddenProjects: function (nodes) {
                    Polymer.dom(this.$.hiddenProjectsSelector).innerHTML = nodes.join('');
                    this._projectsNodes = this.$.hiddenProjectsSelector.childNodes;

                    this.async(function () {
                        log('Initial render time: ', (new Date()).getTime() - this._readyTs);
                    }, 1);
                },

                _ioApplyCurrentFilter: ioApplyCurrentFilter,

                /**
                 * Debounce filter application
                 * @param delay {Number}
                 */
                _delayChanged: function (delay) {
                    if (delay < 1) {
                        this._ioApplyCurrentFilter = ioApplyCurrentFilter;
                    } else {
                        this._ioApplyCurrentFilter = _.debounce(ioApplyCurrentFilter, delay);
                    }
                },

                _debugChanged: function (isOn) {
                    if (isOn)  {
                        log = console.log || emptyFn;
                    } else {
                        log = emptyFn;
                    }
                },

                /**
                 * Extract and prepare template from Light DOM
                 * <template name="group-template"> ... </template>
                 */
                _initProjectTemplate: function () {
                    var projectTemplate = this.queryEffectiveChildren('template[name="group-template"]');

                    if (projectTemplate) {
                        projectTemplate = projectTemplate.innerHTML.trim();
                    } else {
                        projectTemplate = '<div class="project-item__template" is-name>${name}</div>';
                    }

                    this._projectTemplateFn = _.template([
                        '<li class="' + Classes.PROJECT + '" data-id="${id}" data-name="${name}">',
                            '<div class="' + Classes.PROJECT_LEVEL_PREFIX + '${_level}">',
                                projectTemplate,
                            '</div>',
                        '</li>'
                    ].join(''));
                },

                _showProjectNodes: function () {
                    this._isShowAllProjectsVisible = false;
                },

                _filterProjectsNodes: function (filter, isProgressive) {
                    var filtered = this._getFilteredProject(filter, isProgressive);
                    var highlight = [];
                    var filterParts = filter.split(' ');
                    var _node, _id;

                    for (var i = 0, len = this._projectsNodes.length; i < len; i++) {
                        _node = this._projectsNodes[i];
                        _id = _node.getAttribute('data-id');

                        if (filtered[_id]) {
                            _node.style.display = '';
                            highlight.push(_node);
                        } else {
                            _node.style.display = 'none';
                        }
                    }

                    // Highlighting is heavy, so do it async to prevent UI blocks
                    if (! this.noHighlight) {
                        this._highlightJob = this.async(function () {
                            this._highlightProjects(highlight, filterParts);
                        }, 1);
                    }
                },

                /**
                 * Iteratively highlight all nodes (non blocking UI)
                 * @param nodes {Array<Element>}
                 * @param [highlight] {Array<String>} strings to highlight
                 */
                _highlightProjects: function (nodes, highlight, step) {
                    step = step || 0;

                    var stepSize = this.highlightFactor;
                    var index = step * stepSize;
                    var length = index + stepSize > nodes.length
                        ? nodes.length
                        : index + stepSize;

                    while (index < length) {
                        this._highlightProject(nodes[index], highlight);
                        index++;
                    }

                    // Next iteration
                    if (!(index >= nodes.length - 1)) {
                        this._highlightJob = this.async(function () {
                            this._highlightProjects(nodes, highlight, step + 1);
                        }, 1);
                    }
                },

                /**
                 * Highlight node name
                 * @param node {Element}
                 * @param [highlight] {Array<String>} strings to highlight
                 */
                _highlightProject: function (node, highlight) {
                    var name = node.getAttribute('data-name');
                    var nameParts = [];

                    if (highlight) {
                        var _nameTail = name;
                        var _highlight, _exec, _matched;

                        for (var i = 0, len = highlight.length; i < len; i++) {
                            _highlight = highlight[i];
                            _exec = new RegExp('(' + _.escapeRegExp(_highlight) + ')', 'i').exec(_nameTail);

                            if (_exec) {
                                _matched = _exec[1/* take only first match */];
                                nameParts.push(_nameTail.substr(0, _exec.index)
                                    + '<span class="' + Classes.HIGHLIGHT + '">' + _matched + '</span>');
                                _nameTail = _nameTail.substr(_exec.index + _matched.length);
                            }
                        }

                        nameParts.push(_nameTail);
                    } else {
                        nameParts.push(name)
                    }

                    Polymer.dom(Polymer.dom(node).querySelector('[is-name]')).innerHTML = nameParts.join('');
                },

                /**
                 * todo: impl
                 */
                _selectNextProject: function () {
                    if (this._isShowAllProjectsVisible) {
                        this._showProjectNodes();
                    }
                },

                /**
                 * todo: impl
                 */
                _selectPrevProject: function () {
                },

                _onFilterKeyup: function (e) {
                    e.stopPropagation();

                    switch (e.keyCode) {
                        case Keycodes.DOWN:
                            this._selectNextProject();
                            break;
                        case Keycodes.UP:
                            this._selectPrevProject();
                            break;
                        case Keycodes.ENTER:
                            break;
                        default:
                            this._ioApplyCurrentFilter();
                    }

                    /* IE Placeholder show/hide */
                    if (this.$.ieFilterPlaceholder) {
                        if (!!e.target.value) {
                            this.$.ieFilterPlaceholder.classList.add(Classes.HIDDEN);
                        } else {
                            this.$.ieFilterPlaceholder.classList.remove(Classes.HIDDEN);
                        }
                    }
                },

                _onFilterFocus: function (e) {
                    e.target.select();
                },

                _onHiddenProjectTapDelegator: function (e) {
                    e.stopPropagation();
                    var target = getDelegateTarget(e.target, this.$.hiddenProjectsSelector, Classes.PROJECT);

                    if (target) {
                        Polymer.dom(this.$.visibleProjectsSelector).appendChild(target);
                    }
                },

                _onVisibleProjectTapDelegator: function (e) {
                    e.stopPropagation();
                    var target = getDelegateTarget(e.target, this.$.visibleProjectsSelector, Classes.PROJECT);

                    if (target) {
                        Polymer.dom(this.$.hiddenProjectsSelector).appendChild(target);
                    }
                },

                _onShowAllTap: function (e) {
                    e.stopPropagation();
                    this._showProjectNodes();
                },

                /**
                 * Refocus input below
                 */
                _ieOnPlaceholderTap: function (e) {
                    e.stopPropagation();
                    this.$.hiddenProjectsFilter.focus();
                },

                /**
                 * Prevent placeholder text selection
                 */
                _ieOnPlaceholderSelectionStart: function (e) {
                    e.preventDefault();
                    return false;
                }
            });
        })()
    </script>
</dom-module>
