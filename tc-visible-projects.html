<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="./tc-visible-projects-behavior.html">

<!--
## tc-visible-projects
Teamcity component - Configure Visible Projects

### Styling

The following custom properties and mixins are available for styling:

Name | Type | Description | Default
----------------|-------------|----------
`--tc-text-color` | Prop | Text color | #000000
`--tc-primary-color` | Prop |  Application primary color | #0CB0F2
`--tc-secondary-color` | Prop |  Application secondary color | #39E865
`--tc-project-selector-highlight-color` | Prop | Color of filtration highlight | #ffff80
`--tc-project-selector-height` | Prop | Height of project tree (final height will be +32px) | 368px
`--tc-project-selector-item` | Mixin |  Applied to a project item | {}
`--tc-project-selector-item-hover` | Mixin |  Applied to a project item :hover | {}
`--tc-project-selector-item-nth-even` | Mixin |  Applied to a project item :nth-of-type(2n)  | {}

@demo demo/index.html
-->

<dom-module id="tc-visible-projects">
    <template>
        <style>
            :host {
                --tc-text-color: rgba(0,0,0,.87);
                --tc-primary-color: rgba(0,0,0,.87);
                --tc-secondary-color: rgba(0,0,0,.87);
                --tc-project-selector-height: 368px;
                --tc-project-selector-highlight-color: #ffff80;

                display: block;
                color: var(--tc-text-color);
            }

            #body {
                width: 100%;

                table-layout: fixed;
                border-collapse: collapse;
                border-spacing: 0;
            }

            #hiddenProjectsFilter {
                display: block;
                width: 100%;
                height: 1.3em;

                outline: none;
                background-color: transparent;

                margin: 0 0 1px 0;
                padding: 0 0 1px 0;
                font-size: inherit;

                border: none;
                border-bottom: 1px solid rgba(0,0,0,.12);
            }
            #hiddenProjectsFilter:focus {
                margin-bottom: 0;

                border-bottom-width: 2px;
                border-bottom-color: var(--tc-primary-color);
            }

            #searchIcon {
                position: absolute;
                top: 0;
                right: 0;
                z-index: 100;

                width: 20px;
                height: 20px;

                opacity: .3;
            }

            .text-secondary {
                color: var(--tc-text-color, rgba(0,0,0,.54));
            }

            .href-action {
                text-decoration: none;
                color: var(--tc-primary-color);
                border-bottom: 1px dotted var(--tc-primary-color);
            }

            .highlight {
                background-color: var(--tc-project-selector-highlight-color);
            }

            .projects-container {
                width: 50%;
                border-left: 1px solid rgba(0,0,0,.12);
                padding: 0 16px;
                vertical-align: top;
            }

            .projects-container:first-of-type {
                border-left: none;
                padding-left: 0;
            }

            .projects-container__title {
                position: relative;
                font-size: 1.1em;
                height: 32px;
            }

            .projects-container__selector {
                height: var(--tc-project-selector-height);
                overflow: auto;
            }

            .project-item {
                cursor: default;
                @apply(--tc-project-selector-item);
            }
            .project-item:hover {
                @apply(--tc-project-selector-item-hover);
            }
            .project-item:nth-of-type(2n) {
                @apply(--tc-project-selector-item-nth-even);
            }

            /* Hope 9 levels will be enough */
            .project-level-1 { padding-left: 0px; }
            .project-level-2 { padding-left: 20px; }
            .project-level-3 { padding-left: 40px; }
            .project-level-4 { padding-left: 60px; }
            .project-level-5 { padding-left: 80px; }
            .project-level-6 { padding-left: 100px; }
            .project-level-7 { padding-left: 120px; }
            .project-level-8 { padding-left: 140px; }
            .project-level-9 { padding-left: 160px; }
        </style>

        <table id="body">
            <tbody>
                <tr>
                    <td class="projects-container">
                        <div class="projects-container__title">
                            <strong>My visible projects</strong>
                        </div>
                        <div class="projects-container__selector">
                            <div id="visibleProjectsSelector">
                                <!-- ...visible projects will be here... -->
                            </div>
                        </div>
                    </td>

                    <td class="projects-container">
                        <div class="projects-container__title">
                            <!-- "keyup" event used here instead of "input" due to IE9 compatibility -->
                            <input id="hiddenProjectsFilter" type="text"
                                   placeholder="Find projects by name..."
                                   on-keyup="_onFilterKeyup">

                            <!-- Just meaningful icon -->
                            <iron-icon id="searchIcon" icon="icons:search"></iron-icon>
                        </div>

                        <div class="projects-container__selector">

                            <template is="dom-if" if="[[_isLoading]]">
                                <div class="text-secondary">Loading projects...</div>
                            </template>

                            <template is="dom-if" if="[[_isShowAllProjectsVisible]]">
                                <div class="text-secondary">
                                    <strong>[[_projectsNodes.length]]</strong> projects found.
                                    <a class="href-action" href="#" on-tap="_onShowAllTap">
                                        Click or "<strong>â†“</strong>" to show all
                                    </a>
                                </div>
                            </template>

                            <div id="hiddenProjectsSelector">
                                <!-- ...hidden projects will be here... -->
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>

    <script>
        (function () {
            var Keycodes = {
                UP: 38,
                DOWN: 40,
                ENTER: 13,
                ESC: 27
            };

            var Classes = {
                PROJECT: 'project-item',
                PROJECT_LEVEL_PREFIX: 'project-level-',
                HIGHLIGHT: 'highlight'
            };

            var ioApplyCurrentFilter = function () {
                var filter = this._ioGetFilter();

                // Coz we use "keyup" event we should ensure that our filter is changed
                if (filter === this._lastFilterValue) {
                    return;
                }

                var isProgressive = filter.indexOf(this._lastFilterValue) === 0;
                this._lastFilterValue = filter;

                var ts = (new Date()).getTime();
                this._projectsNodes = this._filterProjectsNodes(filter, isProgressive);
                this._showProjectNodes(this._projectsNodes);
                console.log((new Date()).getTime() - ts);
            };

            Polymer({
                is: 'tc-visible-projects',
                behaviors: [ Polymer.jb.TcVisibleProjectsBehavior ],

                properties: {
                    /**
                     * Url to load json data
                     */
                    url: String,

                    /**
                     * Maximum number of projects to display without "Show all..."
                     */
                    projectsDisplayLimit: {
                        type: Number,
                        value: 100
                    },

                    /**
                     * Filtration input debounce delay
                     */
                    delay: {
                        type: Number,
                        value: 100,
                        observer: '_delayChanged'
                    },

                    /**
                     * Maximal count of visible projects. Using for lazy render
                     */
                    maxRows: {
                        type: Number,
                        value: 20
                    }
                },

                /** @type {String} */
                _lastFilterValue: null,

                /** @type {Boolean} */
                _isShowAllProjectsVisible: false,

                /** @type {Boolean} */
                _isLoading: false,

                /** @type {Array<String>} */
                _projectsNodes: null,

                /** @type {Function} */
                _projectTemplateFn: null,

                ready: function () {
                    this._projectsNodes = [];
                    this._initProjectTemplate();
                    this.loadProjects(this.url);
                },

                attached: function () {
                    // Wait ~10 ms until local DOM initialized
                    this.async(function () {
                        this.$.hiddenProjectsFilter.focus();
                    }, null, 10);
                },

                _ioSetLoading: function (isOn) {
                    this._isLoading = isOn;
                },

                _ioGetFilter: function () {
                    return this.$.hiddenProjectsFilter.value.trim();
                },

                /**
                 * Fired when error is thrown.
                 *
                 *     'event.detail.message' {String} error message
                 *     'event.detail.code' {String} error code
                 *
                 * @event error
                 */

                /**
                 * Dispatch 'error' event
                 * @param message {String}
                 * @param code {String}
                 */
                _ioShowError: function (message, code) {
                    this.fire('error', { message: message, code: code });
                },

                /**
                 * Render project as raw HTML
                 * Creates new object because we don`t know which properties from original project object
                 * will be used in project item custom template, so we need them all.
                 * Also highlight the name parts
                 * @param project {Object}
                 * @param [highlight] {String} string to highlight
                 * @return {String}
                 */
                _ioGetProjectHTML: function (project, highlight) {
                    var name = project.name;

                    if (highlight) {
                        name = name.replace(
                            new RegExp('(' + _.escapeRegExp(highlight) + ')', 'i'),
                            '<span class="' + Classes.HIGHLIGHT + '">$1</span>'
                        );
                    }

                    return this._projectTemplateFn(_.create(project, { name: name }));
                },

                _ioApplyCurrentFilter: ioApplyCurrentFilter,

                /**
                 * Debounce filter application
                 * @param delay {Number}
                 */
                _delayChanged: function (delay) {
                    if (delay < 1) {
                        this._ioApplyCurrentFilter = ioApplyCurrentFilter;
                    } else {
                        this._ioApplyCurrentFilter = _.debounce(ioApplyCurrentFilter, delay);
                    }
                },

                /**
                 * Extract and prepare template from Light DOM
                 * <template name="group-template"> ... </template>
                 */
                _initProjectTemplate: function () {
                    var projectTemplate = this.queryEffectiveChildren('template[name="group-template"]');

                    if (projectTemplate) {
                        projectTemplate = projectTemplate.innerHTML.trim();
                    } else {
                        projectTemplate = '${name}';
                    }

                    this._projectTemplateFn = _.template([
                        '<div class="' + Classes.PROJECT + ' ' + Classes.PROJECT_LEVEL_PREFIX + '${_level}">',
                        projectTemplate,
                        '</div>'
                    ].join(''));
                },

                _showProjectNodes: function (nodes, isForced) {
                    this._projectsNodes = nodes;

                    if (!!isForced || this._projectsNodes.length <= this.projectsDisplayLimit) {
                        this._isShowAllProjectsVisible = false;
                        Polymer.dom(this.$.hiddenProjectsSelector).innerHTML = nodes.join('');
                    } else {
                        this._isShowAllProjectsVisible = true;
                        Polymer.dom(this.$.hiddenProjectsSelector).innerHTML = '';
                    }
                },

                /**
                 * todo: impl
                 */
                _selectNextProject: function () {
                    if (this._isShowAllProjectsVisible) {
                        this._showProjectNodes(this._projectsNodes, true);
                    }
                },

                /**
                 * todo: impl
                 */
                _selectPrevProject: function () {
                },

                _onFilterKeyup: function (e) {
                    e.stopPropagation();

                    switch (e.keyCode) {
                        case Keycodes.DOWN:
                            this._selectNextProject();
                            break;
                        case Keycodes.UP:
                            this._selectPrevProject();
                            break;
                        case Keycodes.ENTER:
                            break;
                        default:
                            this._ioApplyCurrentFilter();
                    }
                },

                _onShowAllTap: function (e) {
                    e.stopPropagation();
                    this._showProjectNodes(this._projectsNodes, true);
                }
            });
        })()
    </script>
</dom-module>
